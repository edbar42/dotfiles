#!/bin/bash

link_dotfiles() {
	echo "Linking dotfiles..."
	ls $HOME/dotfiles/config/* 2> /dev/null || exit 1
	for module in $HOME/dotfiles/config/*; do 
		mod_name=$(basename "$path")
		ln -siv $module -t $HOME/.config/$mod_name
	done
}

set_wallpaper() {
/usr/bin/nitrogen --set-zoom-fill --random --save ~/Pictures/wallpapers/ > /dev/null/
}

if [[ "$1" == "sync" ]]; then
	link_dotfiles
	if [[ "$?" == 0 ]]; then
		echo "Dotfiles updated with no errors."
	fi
elif [ $# -eq 0 ]; then
	clear
	echo "We need sudo priviledges for installing packages."
	echo "Please provide your password."
	sudo -v

	echo "Checking if yay is installed on your system..."
	command -v yay &> /dev/null || exit 1 "Yay doesn't seem to be installed."

	echo "Updating repositories..."
	yay -Syy

	echo "Installing dependencies..."
	cat ~/setup/aux/packages | xargs yay -S --needed --noconfirm
	git clone https://github.com/romkatv/powerlevel10k $HOME/powerlevel10k

	echo "Trying to export .zshenv"
	ln -siv $HOME/dotfiles/.zshenv -t $HOME/

	echo "We are backing up your .config to .old-config"
	mv $HOME/.config $HOME/.old-config
	mkdir $HOME/.config

	echo "Changing your shell to zsh"
	chsh -s /bin/zsh

	echo "You will now set up p10k"
	p10k configure

	echo "Linking dotfiles..."
	link_dotfiles

	echo "Setting up a random wallpaper. You can change it later."
	set_wallpaper

	echo "System setup done."

	sleep 1
	echo "We're logging you out of i3 to make sure everything is properly handled."

	sleep 5
	i3-msg exit

else
	echo "Unknown flag."
fi
